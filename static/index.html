<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Orbit AI — профиль</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-main: #020308;
            --bg-card: rgba(10, 12, 20, 0.94);
            --border-soft: rgba(255,255,255,0.08);
            --text-main: #f5f5f7;
            --text-muted: rgba(245,245,247,0.7);
            --accent-grad: radial-gradient(circle at 0% 0%, #ffe66c, #ff9f40 40%, #ff5e62 100%);
            --chip-bg: rgba(255,255,255,0.06);
            --danger: #ff4b6a;
            --success: #2ecc71;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            background:
                radial-gradient(circle at 10% -10%, #1a1c34 0, transparent 55%),
                radial-gradient(circle at 100% 0%, #3b1b4d 0, transparent 55%),
                var(--bg-main);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: stretch;
        }

        .app {
            width: 100%;
            max-width: 420px;
            padding: 14px 14px 22px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 4px 6px;
        }

        .title-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        h1 {
            font-size: 20px;
            letter-spacing: 0.04em;
            font-weight: 650;
        }

        .subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 4px 10px 4px 6px;
            background: radial-gradient(circle at 0 0, rgba(255,255,255,0.2), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow:
                0 0 0 0.5px rgba(255,255,255,0.12),
                0 10px 30px rgba(0,0,0,0.65);
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, #2ecc71);
            box-shadow: 0 0 8px #2ecc71;
        }

        .badge-text {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
        }

        .tabs-wrap {
            padding: 0 4px 4px;
        }

        .tabs {
            display: inline-flex;
            border-radius: 999px;
            padding: 2px;
            background: rgba(4,4,10,0.9);
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 8px 22px rgba(0,0,0,0.7);
        }

        .tab {
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            padding: 5px 14px;
            border-radius: 999px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.14em;
        }

        .tab.active {
            background: rgba(255,255,255,0.12);
            color: var(--text-main);
            box-shadow:
                0 0 0 1px rgba(255,255,255,0.24),
                0 6px 18px rgba(0,0,0,0.7);
        }

        .screens {
            display: flex;
            width: 100%;
            transition: transform 0.25s ease-out;
        }

        .screen {
            flex: 0 0 100%;
            padding-top: 2px;
        }

        .card {
            position: relative;
            border-radius: 22px;
            padding: 14px 14px 12px;
            background:
                radial-gradient(circle at -10% -10%, rgba(255,255,255,0.10), transparent 50%),
                radial-gradient(circle at 120% -10%, rgba(255,255,255,0.06), transparent 55%),
                rgba(8,10,18,0.92);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow:
                0 18px 40px rgba(0,0,0,0.8),
                0 0 0 0.5px rgba(255,255,255,0.12);
            backdrop-filter: blur(22px);
            margin-bottom: 10px;
        }

        .card-inner {
            position: relative;
            z-index: 1;
        }

        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: rgba(245,245,247,0.92);
        }

        .chip {
            font-size: 11px;
            padding: 4px 9px;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.18);
            color: var(--text-muted);
        }

        .divider {
            height: 1px;
            width: 100%;
            background: linear-gradient(
                to right,
                rgba(255,255,255,0),
                rgba(255,255,255,0.28),
                rgba(255,255,255,0)
            );
            margin: 6px 0 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 12px;
        }

        .big-number {
            font-size: 26px;
            font-weight: 650;
            letter-spacing: 0.03em;
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .big-number span.small {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
        }

        .label-column {
            display: flex;
            flex-direction: column;
            gap: 3px;
            align-items: flex-end;
            text-align: right;
        }

        .label-muted {
            font-size: 11px;
            color: var(--text-muted);
        }

        .label-strong {
            font-size: 13px;
            font-weight: 500;
        }

        .tariffs {
            display: flex;
            flex-direction: column;
            gap: 9px;
            margin-top: 2px;
        }

        .tariff-card {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 18px;
            background:
                radial-gradient(circle at 0 0, rgba(255,255,255,0.08), transparent 55%),
                rgba(1,1,6,0.9);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 14px 30px rgba(0,0,0,0.7);
        }

        .tariff-main {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .tariff-title {
            font-size: 13px;
            font-weight: 600;
        }

        .tariff-subtitle {
            font-size: 11px;
            color: var(--text-muted);
        }

        .tariff-orb {
            margin-top: 3px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(245,245,247,0.8);
        }

        .tariff-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-between;
            gap: 4px;
        }

        .tariff-price {
            font-size: 13px;
            font-weight: 600;
        }

        .tariff-btn {
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            background-image: var(--accent-grad);
            color: #000;
            box-shadow:
                0 10px 26px rgba(0,0,0,0.75);
        }

        .tariff-btn:active {
            transform: translateY(1px) scale(0.99);
            box-shadow: 0 6px 18px rgba(0,0,0,0.8);
        }

        .usage-list {
            font-size: 12px;
            color: var(--text-muted);
        }

        .usage-list div {
            display: flex;
            justify-content: space-between;
            margin: 1px 0;
        }

        .usage-label {
            opacity: 0.9;
        }

        .usage-value {
            font-variant-numeric: tabular-nums;
        }

        .row-clickable {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 7px 9px;
            border-radius: 14px;
            background: rgba(255,255,255,0.02);
            border: 1px dashed rgba(255,255,255,0.18);
            cursor: pointer;
            margin-top: 6px;
        }

        .row-clickable:hover {
            border-style: solid;
        }

        .row-clickable .left {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .row-title {
            font-size: 12px;
            font-weight: 500;
        }

        .row-subtitle {
            font-size: 11px;
            color: var(--text-muted);
        }

        .row-value {
            font-size: 11px;
            max-width: 170px;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            background: rgba(6, 8, 16, 0.96);
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow:
                0 10px 34px rgba(0,0,0,0.9),
                0 0 0 0.5px rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            z-index: 1000;
        }

        .toast-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f1c40f, #e67e22);
        }

        .pill {
            border-radius: 999px;
            padding: 3px 7px;
            font-size: 10px;
            border: 1px solid rgba(255,255,255,0.18);
            color: var(--text-muted);
        }

        .pill span.bullet {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: linear-gradient(135deg,#f1c40f,#e67e22);
            display: inline-block;
            margin-right: 4px;
        }

        .usage-list div span {
            display: inline-block;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <div class="title-block">
            <h1>Orbit AI</h1>
            <div class="subtitle" id="subtitle">
                Загрузка профиля…
            </div>
        </div>
        <div class="badge" id="badge">
            <div class="badge-dot" id="badge-dot"></div>
            <div class="badge-text" id="badge-text">online</div>
        </div>
    </div>

    <div class="tabs-wrap">
        <div class="tabs">
            <button class="tab active" id="tab-profile">Профиль</button>
            <button class="tab" id="tab-tariffs">Тарифы</button>
        </div>
    </div>

    <div class="screens" id="screens">
        <div class="screen" data-screen="profile">
            <div class="card">
                <div class="card-inner">
                    <div class="title-row">
                        <div class="card-title">Баланс ORB</div>
                        <div class="chip" id="plan-label">Тариф — …</div>
                    </div>
                    <div class="divider"></div>
                    <div class="info-row">
                        <div class="big-number">
                            <span id="orb-balance">0</span>
                            <span class="small">ORB</span>
                        </div>
                        <div class="label-column">
                            <div class="label-muted">ID пользователя</div>
                            <div class="label-strong" id="user-id">—</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-inner">
                    <div class="title-row">
                        <div class="card-title">Использование моделей</div>
                        <div class="pill"><span class="bullet"></span>Gemini Flash / Pro</div>
                    </div>
                    <div class="divider"></div>
                    <div class="usage-list" id="usage-list">
                        Загрузка…
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-inner">
                    <div class="title-row">
                        <div class="card-title">Реферальная программа</div>
                        <div class="chip">+ORB за друзей</div>
                    </div>
                    <div class="divider"></div>

                    <div class="row-clickable" id="row-user-id">
                        <div class="left">
                            <div class="row-title">Ваш ID</div>
                            <div class="row-subtitle">Нужен, если пишете в поддержку</div>
                        </div>
                        <div class="row-value" id="row-user-id-value">—</div>
                    </div>

                    <div class="row-clickable" id="row-ref-link">
                        <div class="left">
                            <div class="row-title">Реферальная ссылка</div>
                            <div class="row-subtitle">Приглашайте друзей и получайте ORB</div>
                        </div>
                        <div class="row-value" id="row-ref-link-value">—</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" data-screen="tariffs">
            <div class="card">
                <div class="card-inner">
                    <div class="title-row">
                        <div class="card-title">Тарифы ORB</div>
                        <div class="pill"><span class="bullet"></span>Пополнение через бота</div>
                    </div>
                    <div class="divider"></div>
                    <div class="tariffs" id="tariffs"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast">
    <div class="toast-dot"></div>
    <div id="toast-text"></div>
</div>

<script>
(function () {
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

    const subtitleEl = document.getElementById("subtitle");
    const badgeDotEl = document.getElementById("badge-dot");
    const badgeTextEl = document.getElementById("badge-text");

    const planLabelEl = document.getElementById("plan-label");
    const orbBalanceEl = document.getElementById("orb-balance");
    const userIdEl = document.getElementById("user-id");

    const tariffsEl = document.getElementById("tariffs");
    const usageListEl = document.getElementById("usage-list");

    const rowUserIdEl = document.getElementById("row-user-id");
    const rowRefLinkEl = document.getElementById("row-ref-link");
    const rowUserIdValueEl = document.getElementById("row-user-id-value");
    const refLinkEl = document.getElementById("row-ref-link-value");

    const toastEl = document.getElementById("toast");
    const toastTextEl = document.getElementById("toast-text");
    let toastTimer = null;

    const screensEl = document.getElementById("screens");
    const tabProfileEl = document.getElementById("tab-profile");
    const tabTariffsEl = document.getElementById("tab-tariffs");
    let currentScreen = 0; // 0 — профиль, 1 — тарифы

    const TARIFFS = [
        { code: "mini",     title: "MINI",     subtitle: "Пробный пакет",               orbs: 100,  price: "590 ₽"    },
        { code: "standard", title: "STANDARD", subtitle: "Оптимальный выбор",           orbs: 250,  price: "1 390 ₽"  },
        { code: "super",    title: "SUPER",    subtitle: "Для активного использования", orbs: 500,  price: "2 590 ₽"  },
        { code: "premium",  title: "PREMIUM",  subtitle: "Профессиональный уровень",    orbs: 1000, price: "4 490 ₽"  },
        { code: "max",      title: "MAX",      subtitle: "Максимум возможностей",       orbs: 2000, price: "7 990 ₽"  }
    ];

    function showToast(msg) {
        toastTextEl.textContent = msg;
        toastEl.style.display = "flex";
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
            toastEl.style.display = "none";
        }, 1500);
    }

    async function copyToClipboard(text, label) {
        if (!text || text === "—") return;
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
            }
            showToast(label || "Скопировано");
        } catch (e) {
            console.error(e);
            showToast("Не удалось скопировать");
        }
    }

    function renderTariffs() {
        tariffsEl.innerHTML = "";
        TARIFFS.forEach((t) => {
            const card = document.createElement("div");
            card.className = "tariff-card";

            const left = document.createElement("div");
            left.className = "tariff-main";

            const title = document.createElement("div");
            title.className = "tariff-title";
            title.textContent = t.title;

            const subtitle = document.createElement("div");
            subtitle.className = "tariff-subtitle";
            subtitle.textContent = t.subtitle;

            const orb = document.createElement("div");
            orb.className = "tariff-orb";
            orb.textContent = `${t.orbs} ORB`;

            left.appendChild(title);
            left.appendChild(subtitle);
            left.appendChild(orb);

            const right = document.createElement("div");
            right.className = "tariff-right";

            const price = document.createElement("div");
            price.className = "tariff-price";
            price.textContent = t.price;

            const btn = document.createElement("button");
            btn.className = "tariff-btn";
            btn.type = "button";
            btn.textContent = "Купить ORB";
            btn.addEventListener("click", async function () {
                if (!tg) {
                    showToast("Откройте через Telegram, чтобы оплатить");
                    return;
                }

                const initData = tg.initData;
                if (!initData) {
                    showToast("Не удалось получить данные Telegram");
                    return;
                }

                try {
                    const resp = await fetch("/api/create_invoice", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-Telegram-Init-Data": initData
                        },
                        body: JSON.stringify({ pack_code: t.code })
                    });

                    if (!resp.ok) {
                        console.error("Invoice error:", resp.status, await resp.text());
                        showToast("Не удалось создать счёт");
                        return;
                    }

                    showToast("Счёт отправлен в бот");
                } catch (e) {
                    console.error(e);
                    showToast("Ошибка соединения");
                }
            });

            right.appendChild(price);
            right.appendChild(btn);

            card.appendChild(left);
            card.appendChild(right);
            tariffsEl.appendChild(card);
        });
    }

    async function loadProfile() {
        if (!tg) {
            subtitleEl.textContent = "Откройте через Telegram, чтобы увидеть профиль";
            badgeTextEl.textContent = "offline";
            badgeDotEl.style.background = "#ff4b6a";
            return;
        }

        const initData = tg.initData;
        if (!initData) {
            subtitleEl.textContent = "Не удалось получить initData от Telegram.";
            badgeTextEl.textContent = "error";
            badgeDotEl.style.background = "#ff4b6a";
            return;
        }

        try {
            const resp = await fetch("/api/profile", {
                method: "GET",
                headers: {
                    "X-Telegram-Init-Data": initData
                }
            });

            if (!resp.ok) {
                subtitleEl.textContent = "Ошибка загрузки профиля";
                badgeTextEl.textContent = "error";
                badgeDotEl.style.background = "#ff4b6a";
                return;
            }

            const data = await resp.json();

            subtitleEl.textContent = "Ваш профиль в Orbit AI";
            badgeTextEl.textContent = "online";
            badgeDotEl.style.background = "radial-gradient(circle at 30% 30%, #fff, #2ecc71)";

            planLabelEl.textContent = `Тариф — ${data.plan_label || data.plan || "Free"}`;
            orbBalanceEl.textContent = data.orb_balance ?? 0;

            userIdEl.textContent = data.user_id;
            rowUserIdValueEl.textContent = data.user_id;

            refLinkEl.textContent = data.ref_link || "—";

            usageListEl.innerHTML = "";
            if (data.usage) {
                const models = Object.keys(data.usage);
                models.forEach((model) => {
                    const item = document.createElement("div");
                    const left = document.createElement("span");
                    const right = document.createElement("span");
                    left.textContent = model;
                    right.textContent = data.usage[model];
                    left.classList.add("usage-label");
                    right.classList.add("usage-value");
                    item.appendChild(left);
                    item.appendChild(right);
                    usageListEl.appendChild(item);
                });
                if (!usageListEl.innerHTML) {
                    usageListEl.textContent = "Пока нет данных.";
                }
            } else {
                usageListEl.textContent = "Пока нет данных.";
            }
        } catch (e) {
            console.error(e);
            subtitleEl.textContent = "Ошибка сети при загрузке профиля";
            badgeTextEl.textContent = "offline";
            badgeDotEl.style.background = "#ff4b6a";
        }
    }

    function setScreen(index) {
        currentScreen = index;
        screensEl.style.transform = `translateX(-${index * 100}%)`;
        if (index === 0) {
            tabProfileEl.classList.add("active");
            tabTariffsEl.classList.remove("active");
        } else {
            tabProfileEl.classList.remove("active");
            tabTariffsEl.classList.add("active");
        }
    }

    // Переключение по кнопкам сверху
    tabProfileEl.addEventListener("click", () => setScreen(0));
    tabTariffsEl.addEventListener("click", () => setScreen(1));

    // СВАЙП ПО ВСЕЙ ОБЛАСТИ .app: влево — тарифы, вправо — профиль
    const swipeArea = document.querySelector(".app");
    let swipeStartX = null;

    swipeArea.addEventListener("touchstart", function (e) {
        if (!e.touches || e.touches.length !== 1) return;
        swipeStartX = e.touches[0].clientX;
    }, { passive: true });

    swipeArea.addEventListener("touchend", function (e) {
        if (swipeStartX === null) return;
        const touch = e.changedTouches && e.changedTouches[0];
        if (!touch) {
            swipeStartX = null;
            return;
        }

        const dx = touch.clientX - swipeStartX;

        // лёгкий порог — 15 px
        if (dx <= -15) {
            // свайп влево → тарифы
            setScreen(1);
        } else if (dx >= 15) {
            // свайп вправо → профиль
            setScreen(0);
        }

        swipeStartX = null;
    }, { passive: true });

    rowUserIdEl.addEventListener("click", function () {
        copyToClipboard(userIdEl.textContent, "ID скопирован");
    });

    rowRefLinkEl.addEventListener("click", function () {
        copyToClipboard(refLinkEl.textContent, "Реферальная ссылка скопирована");
    });

    document.addEventListener("DOMContentLoaded", function () {
        renderTariffs();
        loadProfile();
        setScreen(0);
    });
})();
</script>

</body>
</html>

